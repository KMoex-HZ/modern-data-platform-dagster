name: Data Engineering Pipeline CI
on: [push]

jobs:
  data-pipeline-validation:
    name: Build and Validate Data Pipeline
    runs-on: ubuntu-latest

    # Defining environment variables for the entire job
    env:
      DUCKDB_PATH: "${{ github.workspace }}/analytics.duckdb"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Configure Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install Project Dependencies
        run: |
          pip install dbt-duckdb soda-core-duckdb pandas faker duckdb pyarrow sqlalchemy duckdb-engine setuptools

      - name: Execute Data Ingestion & Transformation
        run: |
          # Execute synthetic data generator
          python dagster_project/fake_data_gen.py

          # Execute dbt snapshots and models
          cd dbt_project
          dbt snapshot --profiles-dir .
          dbt run --profiles-dir .

      - name: Execute Soda Quality Scans
        run: |
          # No manual path patching needed thanks to environment variables
          soda scan -d analytics -c soda/configuration.yml soda/checks.yml

      - name: Generate dbt Documentation
        run: |
          cd dbt_project
          dbt docs generate --profiles-dir .
