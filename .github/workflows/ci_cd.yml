name: Data Pipeline CI
on: [push]

jobs:
  data-quality-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install dbt-duckdb soda-core-duckdb pandas faker duckdb pyarrow sqlalchemy duckdb-engine setuptools

      - name: Ingest & Build Data
        run: |
          # Jalanin generator (Bikin analytics.duckdb di root)
          python dagster_project/fake_data_gen.py

          # Masuk ke dbt
          cd dbt_project
          dbt snapshot --profiles-dir .
          dbt run --profiles-dir .

      - name: Quality Check
        run: |
          # Sesuaikan path di configuration.yml secara dinamis buat GitHub
          sed -i 's|path:.*|path: /home/runner/work/modern-data-platform-dagster/modern-data-platform-dagster/analytics.duckdb|' soda/configuration.yml
          soda scan -d analytics -c soda/configuration.yml soda/checks.yml

      - name: Generate dbt Docs
        run: |
          cd dbt_project
          dbt docs generate --profiles-dir .
